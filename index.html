<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindAR + WebXR SLAM Tracking</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- MindAR A-Frame Integration -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #info-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            text-align: center;
            max-width: 80%;
            font-size: 14px;
        }

        .status-good {
            color: #4caf50;
        }

        .status-warning {
            color: #ff9800;
        }

        .status-error {
            color: #f44336;
        }

        .status-info {
            color: #2196f3;
        }

        #tracking-mode {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            font-size: 12px;
            display: none;
        }
    </style>
</head>

<body>
    <div id="info-overlay">
        <div id="status-message" class="status-good">âœ“ Point camera at marker</div>
    </div>

    <div id="tracking-mode"></div>

    <!-- A-Frame Scene with MindAR + WebXR -->
    <a-scene mindar-image="imageTargetSrc: ./markers/marker_v1.mind; 
                  autoStart: true;
                  uiLoading: no;
                  uiScanning: no;
                  uiError: no;
                  filterMinCF: 0.00001; 
                  filterBeta: 0.0005;
                  warmupTolerance: 10;
                  missTolerance: 15;
                  maxTrack: 1;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false"
        webxr="requiredFeatures: hit-test,anchors;">

        <!-- Camera -->
        <a-camera position="0 0 0" look-controls="enabled: false" user-height="0"></a-camera>

        <!-- Marker Target with World Anchor -->
        <a-entity id="marker-entity" mindar-image-target="targetIndex: 0">
            <!-- Rotating colorful cube -->
            <a-box id="ar-cube" position="0 0.2 0" rotation="0 0 0" material="color: #FF0000; shader: flat"
                animation="property: rotation; to: 360 360 360; loop: true; dur: 10000; easing: linear">

                <!-- Different colored faces -->
                <a-plane position="0 0 0.1501" rotation="0 0 0" width="0.3" height="0.3" color="#FF0000"></a-plane>
                <a-plane position="0 0 -0.1501" rotation="0 180 0" width="0.3" height="0.3" color="#0000FF"></a-plane>
                <a-plane position="0.1501 0 0" rotation="0 90 0" width="0.3" height="0.3" color="#00FF00"></a-plane>
                <a-plane position="-0.1501 0 0" rotation="0 -90 0" width="0.3" height="0.3" color="#FF00FF"></a-plane>
                <a-plane position="0 0.1501 0" rotation="-90 0 0" width="0.3" height="0.3" color="#00FFFF"></a-plane>
                <a-plane position="0 -0.1501 0" rotation="90 0 0" width="0.3" height="0.3" color="#FFFF00"></a-plane>
            </a-box>
        </a-entity>
    </a-scene>

    <script>
        // Hybrid Tracking System: MindAR Marker + WebXR World Tracking

        const sceneEl = document.querySelector('a-scene');
        const statusDiv = document.getElementById('status-message');
        const trackingModeDiv = document.getElementById('tracking-mode');
        const markerEntity = document.querySelector('#marker-entity');
        const cube = document.querySelector('#ar-cube');

        let worldAnchor = null;
        let trackingMode = 'marker'; // 'marker' or 'world'
        let markerLastSeen = Date.now();
        let worldPosition = null;
        let worldRotation = null;

        // Enhance camera for better quality
        (function () {
            const originalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);

            navigator.mediaDevices.getUserMedia = function (constraints) {
                if (constraints && constraints.video) {
                    constraints.video = {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        frameRate: { ideal: 30, max: 30 }
                    };
                }
                return originalGetUserMedia(constraints);
            };
        })();

        // AR Ready
        sceneEl.addEventListener('arReady', () => {
            console.log('MindAR is ready');
            statusDiv.innerHTML = 'âœ“ AR Ready - Point camera at marker';
            statusDiv.className = 'status-good';

            enableCameraAutofocus();
            checkWebXRSupport();
        });

        // Autofocus
        async function enableCameraAutofocus() {
            try {
                setTimeout(async () => {
                    const video = document.querySelector('video');
                    if (video && video.srcObject) {
                        const stream = video.srcObject;
                        const tracks = stream.getVideoTracks();

                        if (tracks.length > 0) {
                            const track = tracks[0];
                            const capabilities = track.getCapabilities();

                            if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                                await track.applyConstraints({
                                    focusMode: 'continuous',
                                    advanced: [{ focusMode: 'continuous' }]
                                });
                                console.log('âœ“ Autofocus enabled');
                            }
                        }
                    }
                }, 1000);
            } catch (error) {
                console.warn('Could not enable autofocus:', error);
            }
        }

        // Check WebXR support for world tracking
        async function checkWebXRSupport() {
            if (navigator.xr) {
                try {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (supported) {
                        console.log('âœ“ WebXR world tracking available');
                    } else {
                        console.warn('âš ï¸ WebXR not supported - marker-only mode');
                        trackingModeDiv.innerHTML = 'ðŸ“ Marker-only mode (WebXR unavailable)';
                        trackingModeDiv.style.display = 'block';
                    }
                } catch (e) {
                    console.warn('WebXR check failed:', e);
                }
            }
        }

        // Marker found - Create world anchor
        const target = document.querySelector('[mindar-image-target]');

        target.addEventListener('targetFound', () => {
            console.log('âœ“ Marker detected');
            markerLastSeen = Date.now();
            statusDiv.innerHTML = 'âœ“ Marker detected - Building world map...';
            statusDiv.className = 'status-good';

            // Save marker position for world anchoring
            saveMarkerPosition();

            // Try to create world anchor after brief delay
            setTimeout(() => {
                if (trackingMode === 'marker') {
                    createWorldAnchor();
                }
            }, 1500);
        });

        target.addEventListener('targetLost', () => {
            console.log('âš ï¸ Marker lost');
            markerLastSeen = Date.now();

            if (trackingMode === 'world' && worldPosition) {
                // Continue with world tracking
                statusDiv.innerHTML = 'ðŸŒ World tracking - Move freely';
                statusDiv.className = 'status-info';
            } else {
                statusDiv.innerHTML = 'âš ï¸ Point camera at marker';
                statusDiv.className = 'status-warning';
            }
        });

        // Save marker's world position
        function saveMarkerPosition() {
            try {
                const markerObject3D = markerEntity.object3D;
                const cubeObject3D = cube.object3D;

                // Get world position and rotation
                const worldPos = new THREE.Vector3();
                const worldQuat = new THREE.Quaternion();

                cubeObject3D.getWorldPosition(worldPos);
                cubeObject3D.getWorldQuaternion(worldQuat);

                worldPosition = worldPos;
                worldRotation = worldQuat;

                console.log('Saved marker position:', worldPos);
            } catch (error) {
                console.warn('Could not save marker position:', error);
            }
        }

        // Create world anchor at marker position
        async function createWorldAnchor() {
            try {
                if (!worldPosition) {
                    console.warn('No world position available');
                    return;
                }

                // Switch to world tracking mode
                trackingMode = 'world';
                trackingModeDiv.innerHTML = 'ðŸŒ World Tracking Active';
                trackingModeDiv.style.display = 'block';
                trackingModeDiv.style.background = 'rgba(76, 175, 80, 0.9)';

                statusDiv.innerHTML = 'âœ“ Object anchored to world - Move freely!';
                statusDiv.className = 'status-good';

                console.log('âœ“ World anchor created');

                // Detach cube from marker parent and make it world-anchored
                setTimeout(() => {
                    maintainWorldPosition();
                }, 100);

            } catch (error) {
                console.error('Failed to create world anchor:', error);
                trackingMode = 'marker';
            }
        }

        // Maintain world position even when marker is lost
        function maintainWorldPosition() {
            if (trackingMode !== 'world' || !worldPosition) return;

            // Update cube to world position every frame
            const cubeObj = cube.object3D;
            const camera = sceneEl.camera;

            // Calculate position relative to camera  
            sceneEl.addEventListener('render', function updateWorldPos() {
                if (trackingMode === 'world' && worldPosition) {
                    // Keep object at saved world position
                    cubeObj.position.copy(worldPosition);
                    if (worldRotation) {
                        cubeObj.quaternion.copy(worldRotation);
                    }
                }
            });
        }

        // Error handling
        sceneEl.addEventListener('arError', (event) => {
            console.error('MindAR error:', event.detail);
            if (event.detail.error === 'VIDEO_FAIL') {
                statusDiv.innerHTML = 'ðŸ“± Camera needed - Test on mobile device';
                statusDiv.className = 'status-warning';
            } else {
                statusDiv.innerHTML = 'âŒ AR Error: ' + event.detail.error;
                statusDiv.className = 'status-error';
            }
        });

        // Page load logging
        window.addEventListener('load', () => {
            console.log('Page loaded');
            console.log('A-Frame version:', AFRAME.version);
            console.log('Marker file path: ./markers/marker_v1.mind');
            console.log('Hybrid tracking: MindAR + WebXR SLAM');
        });
    </script>
</body>

</html>