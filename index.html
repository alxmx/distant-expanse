<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindAR Marker Tracking</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>

    <!-- MindAR A-Frame Integration -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #info-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            text-align: center;
            max-width: 80%;
            font-size: 14px;
        }

        .status-good {
            color: #4caf50;
        }

        .status-warning {
            color: #ff9800;
        }

        .status-error {
            color: #f44336;
        }
    </style>
</head>

<body>
    <div id="info-overlay">
        <div id="status-message" class="status-good">âœ“ Point camera at marker</div>
    </div>

    <!-- A-Frame Scene with MindAR -->
    <a-scene mindar-image="imageTargetSrc: ./markers/marker_v1.mind; 
                  autoStart: true;
                  uiLoading: no;
                  uiScanning: no;
                  uiError: no;
                  filterMinCF: 0.00001; 
                  filterBeta: 0.0005;
                  warmupTolerance: 10;
                  missTolerance: 15;
                  maxTrack: 1;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">

        <!-- Camera -->
        <a-camera position="0 0 0" look-controls="enabled: false" user-height="0"></a-camera>

        <!-- Marker Target -->
        <a-entity mindar-image-target="targetIndex: 0">
            <!-- Rotating colorful cube -->
            <a-box position="0 0.2 0" rotation="0 0 0" material="color: #FF0000; shader: flat"
                animation="property: rotation; to: 360 360 360; loop: true; dur: 10000; easing: linear">

                <!-- Different colored faces -->
                <a-plane position="0 0 0.1501" rotation="0 0 0" width="0.3" height="0.3" color="#FF0000"></a-plane>
                <a-plane position="0 0 -0.1501" rotation="0 180 0" width="0.3" height="0.3" color="#0000FF"></a-plane>
                <a-plane position="0.1501 0 0" rotation="0 90 0" width="0.3" height="0.3" color="#00FF00"></a-plane>
                <a-plane position="-0.1501 0 0" rotation="0 -90 0" width="0.3" height="0.3" color="#FF00FF"></a-plane>
                <a-plane position="0 0.1501 0" rotation="-90 0 0" width="0.3" height="0.3" color="#00FFFF"></a-plane>
                <a-plane position="0 -0.1501 0" rotation="90 0 0" width="0.3" height="0.3" color="#FFFF00"></a-plane>
            </a-box>
        </a-entity>
    </a-scene>

    <script>
        // MindAR Marker Tracking (Optimized & Stable)

        const sceneEl = document.querySelector('a-scene');
        const statusDiv = document.getElementById('status-message');

        // Enhance camera for better quality
        (function () {
            const originalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);

            navigator.mediaDevices.getUserMedia = function (constraints) {
                if (constraints && constraints.video) {
                    constraints.video = {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        frameRate: { ideal: 30, max: 30 }
                    };
                    console.log('Requesting optimized camera resolution:', constraints.video);
                }
                return originalGetUserMedia(constraints);
            };
        })();

        // AR Ready
        sceneEl.addEventListener('arReady', () => {
            console.log('MindAR is ready');
            statusDiv.innerHTML = 'âœ“ AR Ready - Point camera at marker';
            statusDiv.className = 'status-good';

            enableCameraAutofocus();
        });

        // Autofocus
        async function enableCameraAutofocus() {
            try {
                setTimeout(async () => {
                    const video = document.querySelector('video');
                    if (video && video.srcObject) {
                        const stream = video.srcObject;
                        const tracks = stream.getVideoTracks();

                        if (tracks.length > 0) {
                            const track = tracks[0];
                            const capabilities = track.getCapabilities();

                            if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                                await track.applyConstraints({
                                    focusMode: 'continuous',
                                    advanced: [{ focusMode: 'continuous' }]
                                });
                                console.log('âœ“ Autofocus enabled');
                                statusDiv.innerHTML = 'âœ“ Autofocus ON - Point at marker';
                            }
                        }
                    }
                }, 1000);
            } catch (error) {
                console.warn('Could not enable autofocus:', error);
            }
        }

        // Marker detection events
        const target = document.querySelector('[mindar-image-target]');

        target.addEventListener('targetFound', () => {
            console.log('âœ“ Marker detected');
            statusDiv.innerHTML = 'âœ“ Marker detected - Cube visible';
            statusDiv.className = 'status-good';
        });

        target.addEventListener('targetLost', () => {
            console.log('âš ï¸ Marker lost');
            statusDiv.innerHTML = 'âš ï¸ Point camera at marker';
            statusDiv.className = 'status-warning';
        });

        // Error handling
        sceneEl.addEventListener('arError', (event) => {
            console.error('MindAR error:', event.detail);
            if (event.detail.error === 'VIDEO_FAIL') {
                statusDiv.innerHTML = 'ðŸ“± Camera needed - Test on mobile device';
                statusDiv.className = 'status-warning';
            } else {
                statusDiv.innerHTML = 'âŒ AR Error: ' + event.detail.error;
                statusDiv.className = 'status-error';
            }
        });

        // Page load logging
        window.addEventListener('load', () => {
            console.log('Page loaded');
            console.log('A-Frame version:', AFRAME.version);
            console.log('Marker file: ./markers/marker_v1.mind');
            console.log('Marker tracking: Optimized & stable');
        });
    </script>
</body>

</html>