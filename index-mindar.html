<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>MindAR Marker Tracking</title>

    <!-- MindAR Three.js Integration -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.126.0/build/three.min.js"></script>

    <link rel="stylesheet" href="style.css">

    <style>
        #container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #info-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-family: Arial, sans-serif;
            z-index: 1000;
            text-align: center;
            max-width: 80%;
        }

        #start-button {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-weight: bold;
        }

        #start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status-good {
            color: #4caf50;
        }

        .status-warning {
            color: #ff9800;
        }

        .status-error {
            color: #f44336;
        }
    </style>
</head>

<body>
    <div id="info-overlay">
        <div id="status-message">Loading AR...</div>
    </div>

    <button id="start-button" onclick="startAR()">Start AR Tracking</button>

    <div id="container"></div>

    <script>
        let mindarThree;
        let isARActive = false;

        // Check AR support on page load
        window.addEventListener('load', async () => {
            const statusDiv = document.getElementById('status-message');
            const startBtn = document.getElementById('start-button');

            // Basic compatibility check
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                statusDiv.innerHTML = '❌ Camera access not available';
                statusDiv.className = 'status-error';
                startBtn.disabled = true;
                console.error('Camera API not available');
                return;
            }

            statusDiv.innerHTML = '✓ Ready to start AR tracking';
            statusDiv.className = 'status-good';
            console.log('MindAR ready to initialize');
        });

        async function startAR() {
            const statusDiv = document.getElementById('status-message');
            const startBtn = document.getElementById('start-button');

            if (isARActive) {
                console.log('AR already active');
                return;
            }

            try {
                startBtn.disabled = true;
                statusDiv.innerHTML = 'Initializing AR...';
                statusDiv.className = 'status-warning';

                console.log('Starting MindAR...');

                // Initialize MindAR with marker file
                mindarThree = new window.MINDAR.IMAGE.MindARThree({
                    container: document.querySelector("#container"),
                    imageTargetSrc: './markers/marker_v1.mind',
                    maxTrack: 1, // Track 1 marker at a time
                    filterMinCF: 0.0001,
                    filterBeta: 0.001,
                    warmupTolerance: 5,
                    missTolerance: 5
                });

                const { renderer, scene, camera } = mindarThree;

                console.log('MindAR initialized, creating 3D content...');

                // Add ambient light to make colors visible
                const ambientLight = new THREE.AmbientLight(0xffffff, 1);
                scene.add(ambientLight);

                // Create the colorful cube with different colors on each side
                const materials = [
                    new THREE.MeshBasicMaterial({ color: 0xff0000 }), // Red
                    new THREE.MeshBasicMaterial({ color: 0x0000ff }), // Blue
                    new THREE.MeshBasicMaterial({ color: 0x00ff00 }), // Green
                    new THREE.MeshBasicMaterial({ color: 0xff00ff }), // Magenta
                    new THREE.MeshBasicMaterial({ color: 0x00ffff }), // Cyan
                    new THREE.MeshBasicMaterial({ color: 0xffff00 })  // Yellow
                ];

                const cube = new THREE.Mesh(
                    new THREE.BoxGeometry(0.3, 0.3, 0.3),
                    materials
                );

                // Position cube slightly above the marker center
                cube.position.set(0, 0.2, 0);

                // Create an anchor that will follow the marker
                const anchor = mindarThree.addAnchor(0); // 0 = first marker
                anchor.group.add(cube);

                console.log('Cube attached to marker anchor');

                // Animation loop for cube rotation
                let animationId;
                const animate = () => {
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.01;
                    animationId = requestAnimationFrame(animate);
                };

                // Handle marker found/lost events
                anchor.onTargetFound = () => {
                    console.log('Marker detected!');
                    statusDiv.innerHTML = '✓ Marker detected - Cube visible';
                    statusDiv.className = 'status-good';
                };

                anchor.onTargetLost = () => {
                    console.log('Marker lost');
                    statusDiv.innerHTML = '⚠️ Point camera at marker';
                    statusDiv.className = 'status-warning';
                };

                // Start AR
                await mindarThree.start();
                isARActive = true;
                animate();

                console.log('MindAR started successfully! Point camera at marker.');
                statusDiv.innerHTML = '⚠️ Point camera at marker';
                statusDiv.className = 'status-warning';

                // Render loop
                renderer.setAnimationLoop(() => {
                    renderer.render(scene, camera);
                });

                // Stop button functionality
                startBtn.textContent = 'Stop AR';
                startBtn.disabled = false;
                startBtn.onclick = () => {
                    if (animationId) cancelAnimationFrame(animationId);
                    mindarThree.stop();
                    mindarThree.renderer.setAnimationLoop(null);
                    isARActive = false;
                    startBtn.textContent = 'Start AR Tracking';
                    startBtn.onclick = startAR;
                    statusDiv.innerHTML = 'AR stopped';
                    statusDiv.className = 'status-warning';
                    console.log('AR stopped');
                };

            } catch (error) {
                console.error('MindAR Error:', error);
                statusDiv.innerHTML = '❌ Error: ' + error.message;
                statusDiv.className = 'status-error';
                startBtn.disabled = false;
                startBtn.textContent = 'Retry';
            }
        }
    </script>
</body>

</html>